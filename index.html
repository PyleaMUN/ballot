<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyleaMUN Ballot - Leaderboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #8b5cf6, #fbcfe8); /* Committee-themed gradient */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for longer content */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #fbcfe8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6d28d9;
        }

        /* Styles for the loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5rem;
            color: #6d28d9; /* Purple-700 */
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #a78bfa; /* Purple-400 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for custom message box (instead of alert) */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .custom-alert-box {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
            min-width: 280px;
            font-family: 'Inter', sans-serif;
        }
        .custom-alert-box h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6d28d9; /* Purple-700 */
            margin-bottom: 1rem;
        }
        .custom-alert-box p {
            font-size: 1rem;
            color: #4b5563; /* Gray-700 */
            margin-bottom: 1.5rem;
        }
        .custom-alert-box button {
            background-color: #a78bfa; /* Purple-400 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .custom-alert-box button:hover {
            background-color: #8b5cf6; /* Purple-500 */
        }
        .custom-alert-box input[type="password"] {
            border: 1px solid #ccc;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 80%;
            margin-bottom: 1rem;
            text-align: center;
        }

        .leaderboard-card {
            background-color: white;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-2xl */
            padding: 1.5rem; /* p-6 */
            width: 100%;
            max-width: 768px; /* md:max-w-2xl */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .leaderboard-section {
            margin-bottom: 2rem;
        }

        .leaderboard-list li {
            background-color: #f3f4f6; /* gray-100 */
            padding: 0.75rem 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #4b5563; /* gray-700 */
        }

        .leaderboard-list li:nth-child(odd) {
            background-color: #e5e7eb; /* gray-200 */
        }

        .leaderboard-list li span:first-child {
            font-weight: 600;
            color: #1f2937; /* gray-900 */
        }

        .leaderboard-list li span:last-child {
            font-weight: bold;
            color: #6d28d9; /* purple-700 */
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="selection:bg-purple-200 selection:text-purple-800">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p>Loading Results...</p>
    </div>

    <!-- Custom Alert/Message Box HTML -->
    <div id="custom-alert-overlay" class="custom-alert-overlay hidden">
        <div class="custom-alert-box">
            <h3 id="custom-alert-title"></h3>
            <p id="custom-alert-message"></p>
            <input type="password" id="custom-alert-password" placeholder="Enter password (if required)" class="hidden">
            <button id="custom-alert-ok-button">OK</button>
        </div>
    </div>

    <div class="leaderboard-card">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-purple-700 mb-6 drop-shadow-md">PyleaMUN Ballot Leaderboard</h1>
        <p class="text-center text-gray-600 mb-8 text-sm">Real-time voting results for the organizing committee.</p>

        <!-- User ID Display - Now hidden -->
        <div id="user-id-display" class="text-xs text-gray-500 text-center mb-4 hidden">
            Your User ID: <span id="current-user-id">Loading...</span>
        </div>

        <!-- Best Delegate Leaderboard -->
        <div class="leaderboard-section">
            <h2 class="text-2xl font-bold text-purple-600 mb-4 text-center">üèÜ Best Delegate (Delegate's Choice)</h2>
            <ul id="best-delegate-list" class="leaderboard-list">
                <!-- Results will be dynamically inserted here -->
                <li class="text-gray-500 text-center">Loading results...</li>
            </ul>
        </div>

        <!-- Mr./Ms. Congeniality Leaderboard -->
        <div class="leaderboard-section">
            <h2 class="text-2xl font-bold text-yellow-600 mb-4 text-center">‚ú® Mr./Ms. Congeniality</h2>
            <ul id="congeniality-list" class="leaderboard-list">
                <!-- Results will be dynamically inserted here -->
                <li class="text-gray-500 text-center">Loading results...</li>
            </ul>
        </div>

        <div class="flex justify-center mt-8">
            <button id="reset-data-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-all duration-200 transform hover:-translate-y-1 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                Reset All Data (Admin)
            </button>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, collectionGroup, query, onSnapshot, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (PASTE YOUR SNIPPET HERE)
        const firebaseConfig = {
            apiKey: "AIzaSyC3lYcRp_szMeI4AAeJHSK1UE68MfbMdyY", // Replace with your actual API Key
            authDomain: "pyleamun-voting-app.firebaseapp.com",
            projectId: "pyleamun-voting-app",
            storageBucket: "pyleamun-voting-app.firebasestorage.app",
            messagingSenderId: "519620537793",
            appId: "1:519620537793:web:d20dda66fded4c18e11340",
            measurementId: "G-95R9GTMPLH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variable to store the current user's UID for display
        let currentUserId = null;

        // Map to store delegate profiles fetched from Firestore
        let profileIdToNameMap = new Map();

        // Admin password for reset functionality (CHANGE THIS TO A SECURE PASSWORD!)
        const ADMIN_PASSWORD = "@@Pylea@@26"; // !!! IMPORTANT: CHANGE THIS IN PRODUCTION !!!

        // --- UI Utility Functions ---
        function showLoading(message = "Loading...") {
            document.getElementById('loading-overlay').querySelector('p').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Modified showAlert to include password input
        function showAlert(title, message, type = 'info', callback = null) {
            document.getElementById('custom-alert-title').textContent = title;
            document.getElementById('custom-alert-message').textContent = message;
            const passwordInput = document.getElementById('custom-alert-password');
            const okButton = document.getElementById('custom-alert-ok-button');

            if (type === 'password_prompt') {
                passwordInput.value = ''; // Clear previous input
                passwordInput.classList.remove('hidden');
                okButton.textContent = "Confirm";
            } else {
                passwordInput.classList.add('hidden');
                okButton.textContent = "OK";
            }

            document.getElementById('custom-alert-overlay').classList.remove('hidden');
            
            okButton.onclick = () => {
                document.getElementById('custom-alert-overlay').classList.add('hidden');
                if (callback) callback(passwordInput.value); // Pass password value to callback
            };
        }

        // --- Firebase Authentication for Leaderboard ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                // User ID is no longer displayed, but still useful for debugging in console
                // document.getElementById('current-user-id').textContent = currentUserId; 
                console.log("Leaderboard user signed in:", currentUserId);
                // Start loading data once authenticated
                loadLeaderboardData();
            } else {
                console.log("No user signed in on leaderboard. Signing in anonymously...");
                signInAnonymously(auth)
                    .then(() => {
                        console.log("Anonymous sign-in successful for leaderboard.");
                        // onAuthStateChanged will trigger again with the new user
                    })
                    .catch((error) => {
                        console.error("Anonymous sign-in failed for leaderboard:", error);
                        showAlert("Authentication Error", "Could not sign you in to view results. Please try again.");
                    });
            }
        });

        /**
         * Fetches all delegate profiles from Firestore and populates the map.
         */
        async function fetchDelegateProfiles() {
            showLoading("Fetching delegate profiles...");
            profileIdToNameMap = new Map(); // Clear previous map
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Corrected path to include 'data' document to make segments odd
                const delegatesCollectionRef = collection(db, `artifacts/${appId}/public/data/delegates`);
                const querySnapshot = await getDocs(delegatesCollectionRef);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    profileIdToNameMap.set(data.id, `${data.name} ${data.surname}`);
                });
                console.log("Fetched delegate names:", profileIdToNameMap);
            } catch (error) {
                console.error("Error fetching delegate profiles for leaderboard:", error);
                showAlert("Error", "Could not load delegate names. Check console for details.");
            } finally {
                // Keep loading visible until votes are also fetched
            }
        }

        /**
         * Listens for real-time updates to all vote documents in Firestore
         * and updates the leaderboard.
         */
        function listenForVotes() {
            showLoading("Loading votes...");
            // Ensure __app_id is defined. If running outside Canvas, provide a fallback.
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // Query all 'votes' subcollections across all users
            // This requires a Collection Group Index on 'votes' (see instructions below)
            const votesCollectionGroupRef = collectionGroup(db, 'votes');
            const q = query(votesCollectionGroupRef);

            // Set up real-time listener
            onSnapshot(q, (querySnapshot) => {
                const bestDelegateVotes = {};
                const congenialityVotes = {};

                querySnapshot.forEach((doc) => {
                    const voteData = doc.data();
                    const candidateId = voteData.candidateId;
                    const voteType = voteData.voteType;

                    if (voteType === 'bestDelegate') {
                        bestDelegateVotes[candidateId] = (bestDelegateVotes[candidateId] || 0) + 1;
                    } else if (voteType === 'congeniality') {
                        congenialityVotes[candidateId] = (congenialityVotes[candidateId] || 0) + 1;
                    }
                });

                updateLeaderboardDisplay('best-delegate-list', bestDelegateVotes);
                updateLeaderboardDisplay('congeniality-list', congenialityVotes);
                hideLoading(); // Hide loading after both profiles and votes are processed
            }, (error) => {
                console.error("Error listening for votes:", error);
                showAlert("Error", "Could not load real-time results. Check console for details.");
                hideLoading();
            });
        }

        /**
         * Updates the HTML list for a given leaderboard category.
         * @param {string} listId - The ID of the <ul> element.
         * @param {object} votes - An object mapping candidateId to vote count.
         */
        function updateLeaderboardDisplay(listId, votes) {
            const listElement = document.getElementById(listId);
            listElement.innerHTML = ''; // Clear previous results

            const sortedCandidates = Object.entries(votes).sort(([, countA], [, countB]) => countB - countA);

            if (sortedCandidates.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500 text-center">No votes cast yet.</li>';
                return;
            }

            sortedCandidates.forEach(([candidateId, count]) => {
                const listItem = document.createElement('li');
                // Use the dynamically fetched name
                const candidateName = profileIdToNameMap.get(candidateId) || `Unknown Delegate (${candidateId})`;
                listItem.innerHTML = `<span>${candidateName}</span><span>${count} votes</span>`;
                listElement.appendChild(listItem);
            });
        }

        /**
         * Main function to load all necessary data for the leaderboard.
         */
        async function loadLeaderboardData() {
            await fetchDelegateProfiles(); // First, get all delegate names
            listenForVotes(); // Then, start listening for votes
        }

        // --- Reset Data Functionality ---
        document.getElementById('reset-data-button').addEventListener('click', () => {
            showAlert(
                "Confirm Reset",
                "Are you sure you want to delete ALL delegate nominations and votes? This action cannot be undone. Enter admin password to confirm.",
                'password_prompt',
                async (password) => {
                    if (password === ADMIN_PASSWORD) {
                        await resetAllData();
                    } else {
                        showAlert("Access Denied", "Incorrect password. Data reset cancelled.");
                    }
                }
            );
        });

        async function resetAllData() {
            showLoading("Deleting all data...");
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // 1. Delete all delegate profiles
                const delegatesCollectionRef = collection(db, `artifacts/${appId}/public/data/delegates`);
                const delegateDocs = await getDocs(delegatesCollectionRef);
                const deleteDelegatePromises = [];
                delegateDocs.forEach((docItem) => {
                    deleteDelegatePromises.push(deleteDoc(doc(db, `artifacts/${appId}/public/data/delegates`, docItem.id)));
                });
                await Promise.all(deleteDelegatePromises);
                console.log("All delegate profiles deleted.");

                // 2. Delete all vote documents (from all user subcollections)
                // This requires iterating through users and their vote subcollections
                // For simplicity and to avoid complex backend functions, we'll fetch all votes
                // and delete them one by one. For very large datasets, a Cloud Function
                // would be more efficient for mass deletion.
                const votesCollectionGroupRef = collectionGroup(db, 'votes');
                const voteDocs = await getDocs(votesCollectionGroupRef);
                const deleteVotePromises = [];
                voteDocs.forEach((docItem) => {
                    // Reconstruct the full path for deletion
                    // docItem.ref.path gives the full path, e.g., artifacts/app_id/users/user_id/votes/vote_id
                    deleteVotePromises.push(deleteDoc(doc(db, docItem.ref.path)));
                });
                await Promise.all(deleteVotePromises);
                console.log("All vote records deleted.");

                showAlert("Success!", "All delegate nominations and votes have been cleared.", () => {
                    // Reload the page to reflect the empty state
                    window.location.reload();
                });

            } catch (error) {
                console.error("Error resetting data:", error);
                showAlert("Error", "Failed to reset data. Check console for details and ensure security rules allow deletion.");
            } finally {
                hideLoading();
            }
        }


        // Initial setup when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', () => {
            // Authentication listener will trigger `loadLeaderboardData`
        });
    </script>
</body>
</html>
